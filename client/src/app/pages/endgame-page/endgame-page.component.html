<div class="endgame-container">
    <div class="stats-container">
        <h1>Fin de partie</h1>
        <table id="stats-table">
            <thead>
                <tr>
                    <th></th>
                    <th>Joueur</th>
                    <th (click)="endgameService.sortCombats()">
                        Combats <span>{{ endgameService.isCombatSortingAsc ? 'â†“' : 'â†‘' }}</span>
                    </th>
                    <th (click)="endgameService.sortEvasions()">
                        Ã‰vasions <span>{{ endgameService.isEvasionSortingAsc ? 'â†“' : 'â†‘' }}</span>
                    </th>
                    <th (click)="endgameService.sortVictories()">
                        Victoires <span>{{ endgameService.isVictoriesSortingAsc ? 'â†“' : 'â†‘' }}</span>
                    </th>
                    <th (click)="endgameService.sortDefeats()">
                        DÃ©faites <span>{{ endgameService.isDefeatsSortingAsc ? 'â†“' : 'â†‘' }}</span>
                    </th>
                    <th (click)="endgameService.sortLostLife()">
                        Vie perdue <span>{{ endgameService.isLostLifeSortingAsc ? 'â†“' : 'â†‘' }}</span>
                    </th>
                    <th (click)="endgameService.sortStolenLife()">
                        Vie infligÃ©e <span>{{ endgameService.isStolenLifeSortingAsc ? 'â†“' : 'â†‘' }}</span>
                    </th>
                    <th (click)="endgameService.sortObjects()">
                        Objets ramassÃ©s <span>{{ endgameService.isObjectsSortingAsc ? 'â†“' : 'â†‘' }}</span>
                    </th>
                    <th (click)="endgameService.sortVisitedTiles()">
                        Tuiles visitÃ©es <span>{{ endgameService.isTilesSortingAsc ? 'â†“' : 'â†‘' }}</span>
                    </th>
                </tr>
            </thead>
            <tbody>
                @for (gamePlayer of players; track gamePlayer.socketId) {
                <tr
                    [style.background-image]="getPlayerBanner(gamePlayer.name) ? 'url(' + getPlayerBanner(gamePlayer.name) + ')' : 'none'"
                    [class.has-banner]="getPlayerBanner(gamePlayer.name)"
                >
                    @if (!getPlayerBanner(gamePlayer.name)) {
                    <td class="player-cell"></td>
                    }
                    <td class="player-cell">
                        <div class="cell-content player-info">
                            <img [src]="getAvatarPreview(gamePlayer.avatar)" class="player-avatar" alt="avatar" />
                            <span class="player-name">{{ gamePlayer.name }}</span>
                            @if (!isVirtualPlayer(gamePlayer.socketId)) {
                            <img class="user-level" [src]="'assets/level-badges/level-' + gamePlayer.level + '.png'" alt="Niveau" />
                            } @if (isVirtualPlayer(gamePlayer.socketId)) {
                            <img src="assets/icons/robot.png" alt="Bot" class="robot-icon" />
                            }
                        </div>
                    </td>
                    <td class="player-cell">
                        <div class="cell-content">{{ gamePlayer.specs.nCombats }}</div>
                    </td>
                    <td class="player-cell">
                        <div class="cell-content">{{ gamePlayer.specs.nEvasions }}</div>
                    </td>
                    <td class="player-cell">
                        <div class="cell-content">{{ gamePlayer.specs.nVictories }}</div>
                    </td>
                    <td class="player-cell">
                        <div class="cell-content">{{ gamePlayer.specs.nDefeats }}</div>
                    </td>
                    <td class="player-cell">
                        <div class="cell-content">{{ gamePlayer.specs.nLifeLost }}</div>
                    </td>
                    <td class="player-cell">
                        <div class="cell-content">{{ gamePlayer.specs.nLifeTaken }}</div>
                    </td>
                    <td class="player-cell">
                        <div class="cell-content">{{ gamePlayer.specs.nItemsUsed }}</div>
                    </td>
                    <td class="player-cell">
                        <div class="cell-content">{{ endgameService.getPlayerTilePercentage(gamePlayer, game) }}%</div>
                    </td>
                </tr>
                }
            </tbody>
        </table>
    </div>
    <button class="chat-toggle-button" aria-label="Toggle global chat" (click)="isChatVisible = !isChatVisible">
        <span class="material-icons">chat_bubble_outline</span>
    </button>
    <div class="global-chat-wrapper" [hidden]="!isChatVisible">
        <app-chatroom [gameId]="this.game.id" [isInGame]="true" (closed)="isChatVisible = false"></app-chatroom>
    </div>
    <div class="global-stats-container">
        <h1>Statistiques globales de la partie</h1>
        <p>DurÃ©e de la partie : {{ endgameService.gameDurationInMinutes(game.duration) }}</p>
        <p>Tours de jeu : {{ game.nTurns }}</p>
        <p>Pourcentage total de tuiles visitÃ©es : {{ endgameService.gameTilePercentage(game) }}%</p>
        <p>Pourcentage total des portes manipulÃ©es : {{ endgameService.gameDoorPercentage(game) }}%</p>
        @if (isGameCtf(game)) {
        <p>Nombre de joueurs diffÃ©rents ayant dÃ©tenu le drapeau : {{ endgameService.getFlagPickupPlayers(game) }}</p>
        }
    </div>
    <div class="exit-button-container">
        @if (moneyReward > 0 || challengeReward > 0) {
        <div class="money-reward-card">
            <div class="reward-icon">
                <img src="assets/icons/money.png" alt="Money icon" />
            </div>
            <div class="reward-content">
                <h2>RÃ©compenses</h2>
                <div class="total-amount">+{{ moneyReward + challengeReward }} piÃ¨ces</div>
                <div class="reward-breakdown">
                    @if (moneyReward > 0) {
                    <div class="breakdown-item">
                        <span>Partie:</span>
                        <span class="amount">+{{ moneyReward }}</span>
                    </div>
                    } @if (challengeReward > 0) {
                    <div class="breakdown-item">
                        <span>DÃ©fi:</span>
                        <span class="amount">+{{ challengeReward }}</span>
                    </div>
                    }
                </div>
            </div>
        </div>
        }
        <button (click)="navigateToMain()">Menu principal</button>
    </div>
    @if(showLevelModal){
    <div class="levelup-backdrop">
        <div class="levelup-modal">
            <h2>FÃ©licitations ! ðŸŽ‰</h2>
            <p>
                Tu viens de passer au <strong>niveau {{ newLevel }}</strong> !
            </p>

            @if (bannerUnlocked) {
            <p>Tu as dÃ©bloquÃ© une nouvelle banniÃ¨re. Va voir la boutique pour la dÃ©couvrir !</p>
            } @else {
            <p>Continue de jouer, une nouvelle banniÃ¨re tâ€™attend tous les 5 niveaux.</p>
            }

            <div class="levelup-action">
                <button (click)="showLevelModal = false">OK</button>
            </div>
        </div>
    </div>
    }
</div>
