<div class="friends-container">
    <div class="friends-header">
        <div class="tabs-container">
            <button class="tab-button" [class.active]="activeTab === 'friends'" (click)="switchTab('friends')">Amis ({{ friends.length }})</button>
            <button class="tab-button" [class.active]="activeTab === 'requests'" (click)="switchTab('requests')">
                Demandes @if (getFriendRequestsCount() > 0) {
                <span class="notification-badge">{{ getFriendRequestsCount() }}</span>
                }
            </button>
        </div>

        @if (activeTab === 'friends') {
        <div class="search-section">
            @if (friendError) {
            <div class="error-message" [class.success-message]="friendErrorType === 'success'">{{ friendError }}</div>
            }
        </div>
        }
    </div>

    @if (activeTab === 'friends') {
    <div class="users-list">
        @if (getTotalUsersCount() === 0 && !isLoadingUsers) {
        <div class="no-users">
            <i class="fas fa-users"></i>
            <p>Aucun utilisateur trouvé</p>
        </div>
        } @else if (isLoadingUsers) {
        <div class="loading-users">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Chargement des utilisateurs...</p>
        </div>
        } @else {

        <div class="two-column-layout">
            <!-- Section Amis -->
            <div class="column friends-column">
                @if (getFilteredFriends().length > 0 || friends.length > 0) {
                <div class="section-header clickable" (click)="toggleFriendsSection()">
                    <h4>
                        <i
                            class="fas toggle-icon"
                            [class.fa-chevron-down]="!friendsSectionCollapsed"
                            [class.fa-chevron-right]="friendsSectionCollapsed"
                        ></i>
                        Mes Amis ({{ getFilteredFriends().length }})
                    </h4>
                </div>
                @if (!friendsSectionCollapsed) {
                <div class="column-content">
                    @for (user of getFilteredFriends(); track user.username) {
                    <div
                        class="user-item friend-user"
                        [style.background-image]="getFriendBanner(user.username) ? 'url(' + getFriendBanner(user.username) + ')' : 'none'"
                        [class.has-banner]="getFriendBanner(user.username)"
                    >
                        <div class="user-content">
                            <div class="user-info">
                                <div class="user-left">
                                    <div class="user-avatar">
                                        @if (getUserProfilePictureUrl(user)) {
                                        <img [src]="getUserProfilePictureUrl(user)" [alt]="user.username + ' photo de profil'" class="avatar-image" />
                                        } @else {
                                        <i class="fas fa-user"></i>
                                        }
                                    </div>

                                    <div class="user-details">
                                        <div class="user-header">
                                            <div class="user-name">{{ user.username }}</div>
                                            <img
                                                class="user-level"
                                                [src]="'assets/level-badges/level-' + getFriendLevel(user.username) + '.png'"
                                                alt="Niveau"
                                            />
                                        </div>
                                        <div class="user-status" [class]="getStatusClass(user.status)">
                                            <span class="status-dot"></span>
                                            {{ getStatusText(user.status) }}
                                        </div>
                                    </div>
                                </div>

                                <button (click)="removeFriend(user.username)" class="remove-friend-btn" title="Supprimer ami">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    }
                </div>
                } }
            </div>

            <!-- Section Autres Utilisateurs -->
            <div class="column others-column">
                @if (getFilteredOtherUsers().length > 0 || allUsers.length > 0) {
                <div class="section-header clickable" (click)="toggleOthersSection()">
                    <h4>
                        <i
                            class="fas toggle-icon"
                            [class.fa-chevron-down]="!othersSectionCollapsed"
                            [class.fa-chevron-right]="othersSectionCollapsed"
                        ></i>
                        Autres Utilisateurs
                    </h4>
                </div>
                @if (!othersSectionCollapsed) {
                <input
                    type="text"
                    [(ngModel)]="othersSearchQuery"
                    placeholder="Rechercher d'autres utilisateurs..."
                    class="search-input-small"
                    (input)="onOthersSearchInput($event)"
                />
                <div class="column-content">
                    @for (user of getFilteredOtherUsers(); track user.username) {
                    <div class="user-item other-user">
                        <div class="user-info">
                            <div class="user-details">
                                <div class="user-header">
                                    <div class="user-name">{{ user.username }}</div>
                                    <img
                                        class="user-level"
                                        [src]="'assets/level-badges/level-' + getFriendLevel(user.username) + '.png'"
                                        alt="Niveau"
                                    />
                                </div>
                                @if (getPendingRequestStatus(user.username)) {
                                <div class="pending-status">{{ getPendingRequestStatus(user.username) }}</div>
                                }
                            </div>
                        </div>

                        @if (!hasPendingRequest(user.username)) {
                        <button
                            (click)="addFriendFromList(user.username)"
                            [disabled]="isAddingFriend"
                            class="add-friend-btn-list"
                            title="Ajouter ami"
                        >
                            @if (isAddingFriend && selectedUserForAdd === user.username) {
                            <i class="fas fa-spinner fa-spin"></i>
                            } @else {
                            <i class="fas fa-plus"></i>
                            }
                        </button>
                        }
                    </div>
                    }
                </div>
                } }
            </div>
        </div>
        }
    </div>
    } @else if (activeTab === 'requests') {
    <div class="friend-requests-list">
        @if (friendRequests.length === 0) {
        <div class="no-requests">
            <i class="fas fa-user-clock"></i>
            <p>Aucune demande d'amitié en attente</p>
            <p class="subtitle">Les demandes que vous recevez apparaîtront ici</p>
        </div>
        } @else { @for (request of friendRequests; track request.from) {
        <div class="request-item">
            <div class="request-info">
                <div class="request-avatar">
                    <i class="fas fa-user"></i>
                </div>

                <div class="request-details">
                    <div class="request-name">{{ request.from }}</div>
                    <div class="request-message">Souhaite être votre ami</div>
                </div>
            </div>

            <div class="request-actions">
                <button (click)="acceptFriendRequest(request.from)" class="accept-btn" title="Accepter">
                    <i class="fas fa-check"></i>
                </button>
                <button (click)="rejectFriendRequest(request.from)" class="reject-btn" title="Refuser">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        } }
    </div>
    }
</div>
