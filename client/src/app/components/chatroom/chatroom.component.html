<div class="chat-container" [class.retracted]="isChatRetracted">
    @if (showNotification && !showDeleteConfirmation) {
    <div class="notification-toast">
        {{ notificationMessage }}
    </div>
    } @if (showDeleteConfirmation) {
    <div class="delete-confirmation-toast">
        <div class="confirmation-message">{{ notificationMessage }}</div>
        <div class="confirmation-buttons">
            <button class="confirm-btn" (click)="confirmDeleteChannel()">Oui</button>
            <button class="cancel-btn" (click)="cancelDeleteChannel()">Non</button>
        </div>
    </div>
    }

    <div class="chat-header" (click)="toggleChat()">
        <div class="header-left">
            <strong>Clavardage</strong>
            <span class="toggle-icon">
                <i [ngClass]="isChannelRetracted ? 'fas fa-comments' : 'fas fa-comment-dots'" (click)="toggleChannel()"></i>
            </span>
        </div>
        <button class="close-button" (click)="closeChat(); $event.stopPropagation()">×</button>
    </div>
    @if (!isChannelRetracted) {
    <div class="channel-controls">
        <button class="channel-button" (click)="toggleAvailableChannels()">
            Salons disponibles
            <i [ngClass]="showAvailableChannels ? 'fas fa-chevron-up' : 'fas fa-chevron-down'"></i>
        </button>
        <button class="channel-button" (click)="toggleJoinedChannels()">
            Salons rejoints
            <i [ngClass]="showJoinedChannels ? 'fas fa-chevron-up' : 'fas fa-chevron-down'"></i>
        </button>
    </div>

    @if (showAvailableChannels) {
    <div class="channel-panel">
        <div class="create-channel">
            <input [(ngModel)]="channelSearchText" maxlength="20" placeholder="Rechercher un salon..." class="search-input" />
            <button class="create-btn" (click)="toggleCreateModal()">+</button>
        </div>
        <div class="channel-list">
            @for (channel of getFilteredAvailableChannels(); track channel.name) {
            <div class="channel-item">
                <span class="channel-name">{{ channel.name }}</span>
                <div class="channel-actions">
                    <button class="join-btn" (click)="joinChannel(channel)">Rejoindre</button>
                    <button class="delete-btn" (click)="deleteChannel(channel.name)">Supprimer</button>
                </div>
            </div>
            }
        </div>
    </div>
    } @if (showJoinedChannels) {
    <div class="channel-panel">
        <div class="channel-list">
            @for (channel of joinedChannels; track channel.name) {
            <div class="channel-item" [class.active]="channel.name === activeChannel">
                <span class="channel-name" (click)="selectActiveChannel(channel.name)">{{ channel.name }}</span>
                <div class="channel-actions">
                    @if (channel.name !== 'global' && channel.name !== ('partie-' + gameId)) {
                    <button class="leave-btn" (click)="leaveChannel(channel.name)">Quitter</button>
                    }
                </div>
            </div>
            }
        </div>
    </div>
    } }
    <section class="chat-section">
        <div class="chat-header-info">
            @if (activeChannel) {
            <span class="active-channel">Salon actuel: {{ activeChannel }}</span>
            }
        </div>
        <div id="messageArea" class="message-area">
            <ul id="messageList">
                @for (message of messages; track $index) {
                <li class="message-item">
                    @if (message.author) {
                    <div class="message-content">
                        <div class="message-header">
                            <div class="author-info">
                                <div class="author-avatar">
                                    @if (isDeletedAccount(message.author)) {
                                    <i class="fas fa-user"></i>
                                    } @else if (getMessageAuthorImageUrl(message)) {
                                    <img [src]="getMessageAuthorImageUrl(message)" [alt]="message.author + ' image'" class="avatar-image" />
                                    } @else {
                                    <i class="fas fa-user"></i>
                                    } @if ((isAuthorFriend(message.author) || message.author === playerName) && message.authorStatus) {
                                    <div class="status-indicator" [class]="'status-' + message.authorStatus"></div>
                                    }
                                </div>
                                <div class="author-details">
                                    <span class="author">{{ message.author }}</span>
                                    @if ((isAuthorFriend(message.author) || message.author === playerName) && message.authorStatus) {
                                    <span class="author-status" [class]="'status-text-' + message.authorStatus">{{
                                        getStatusText(message.authorStatus)
                                    }}</span>
                                    }
                                </div>
                            </div>
                            <span class="timestamp">{{ message.timestamp | date: 'HH:mm:ss' }}</span>
                        </div>
                        <div class="message-text">{{ message.text }}</div>
                    </div>
                    }
                </li>
                }
            </ul>
        </div>

        <div class="input-container">
            <input
                #messageInput
                id="messageInput"
                placeholder="Votre message"
                [(ngModel)]="messageText"
                (keydown.enter)="sendMessage()"
                maxlength="200"
                type="text"
            />
            <div class="send-message-button" (click)="sendMessage(); messageInput.focus()">
                <img src="assets/icons/arrow.png" alt="Trophée" class="icon" />
            </div>
        </div>
    </section>

    @if (showCreateModal) {
    <div class="create-modal-overlay" (click)="toggleCreateModal()">
        <div class="create-modal" (click)="$event.stopPropagation()">
            <h3 class="modal-title">Créer un salon</h3>
            <div class="modal-input-container">
                <input
                    [(ngModel)]="newChannelNameModal"
                    maxlength="20"
                    placeholder="Nom du salon"
                    class="modal-input"
                    (keydown.enter)="createChannelFromModal()"
                    autofocus
                />
                <span class="char-counter">{{ newChannelNameModal.length }}/20</span>
            </div>
            <div class="modal-buttons">
                <button class="modal-cancel-btn" (click)="toggleCreateModal()">Annuler</button>
                <button class="modal-create-btn" (click)="createChannelFromModal()">Créer</button>
            </div>
        </div>
    </div>
    }
</div>
